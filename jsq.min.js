;(function() {var e=void 0,g=!0,j=null,k=!1,l,m=this;function n(a){for(var b=1;b<arguments.length;b++)if(arguments[b]instanceof Object)for(var c in arguments[b])a[c]=arguments[b][c];return a}function q(a){if(!(a instanceof Object))return a;var b=new a.constructor;r(a,function(a,d){b[d]=q(a)});return b}function r(a,b){if(a instanceof Array)for(var c=0,d=a.length;c<d;c++){if(b(a[c],c,a)===k)return k}else if(a instanceof Object)for(c in a)if(b(a[c],c,a)===k)return k;return g}
function s(a,b,c){if(b instanceof Array&&!c)return Math[a].apply(Math,b);if(b instanceof Object){var d,f;r(b,function(b){var i=c?u([b],[],c)[0]:b;if(i!==e&&(d===e||Math[a](d,i)==i))d=i,c&&(f=b)});return c?f:d}return b}function v(a){var b=Array.prototype.slice.call(arguments,1);return typeof a==x.g&&a.replace(/%(\d+)/g,function(a,d){return b[d]||""})}function y(a){a||(a="Unknown error");throw v.apply(this,arguments);}
function z(a,b,c,d){var f=c.children[1].value,h=c.children[0],c=c.children[2],h=h.name==x.k?[h.value]:u(a,[],h),a=c.name==x.k?[c.value]:u(a,[],c),i,t;h.length||(h=[d]);a.length||(a=[d]);for(c=0;c<h.length;c++)for(i=0;i<a.length;i++){switch(f){case "+":case "-":case "*":case "/":case "and":case "or":case "xor":case "&&":case "||":case "==":case "===":case "!=":case ">=":case "<=":case ">":case "<":t=z.S[f](h[c],a[i])}t!=d&&b.push(t);t=d}}
function u(a,b,c){var d;switch(c.name){case x.A:var f=c.children;if(2==f.length)A[f[1].value]=u(a,[],f[0]),a instanceof Array?b.push.apply(b,a):b.push(a);else if(3==f.length){c=f[1].value;d=q(a);var h;"="==c?(h=u(a,[],f[2]).pop()||j,B(d,d,j,f[0].children,function(a,b,c){c[b]=h})):"|="==c&&B(d,d,j,f[0].children,function(a,b,c){h=u([c[b]],[],f[2]).pop()||j;c[b]=h});b.push.apply(b,d)}break;case x.v:z(a,b,c);break;case x.BOOL:b.push("true"==c.value?g:k);break;case x.C:d=[];c.children.length&&u(a,d,c.children[0]);
b.push(d);break;case x.m:for(d=0;d<c.children.length;d++)u(a,b,c.children[d]);break;case x.j:B(a,a,b,c.children);break;case x.D:if(c.value&&"function"==typeof C.fn[c.value])C.fn[c.value](a[0],b,c.children[0]&&c.children[0].children[0]);break;case x.H:b.push(j);break;case x.k:case x.g:b.push(c.value);break;case x.I:D(a,b,c.children);break;case x.J:c=u(a,[],c.children[0]);b.push.apply(b,c);break;case x.q:a=u(a,b,c.children[0]);a=a.splice(0,a.length);for(d=0;d<a.length;d++)u([a[d]],b,c.children[1]);
break;case x.L:d=c.value;c=u(a,[],c.children[0]);for(a=0;a<c.length;a++)"!"===d?b.push(!c[a]):"-"===d?b.push(-c[a]):"~"===d&&b.push(~c[a]);break;case x.M:b.push(e);break;case x.O:b.push.apply(b,A[c.value])}return b}
function B(a,b,c,d,f){var h,i,t,p,w;f||(f=function(a){a!=e&&c.push(a)});d=d.slice(0);a===b&&(h=d.shift(),!h.value&&h.children.length&&(b=u(b,[],h.children[0])));h=d.shift();for(t=0;t<b.length;t++)if(p=b[t],p!=e)if(h)if(h.name==x.G)r(p,!d.length?f:function(b){B(a,[b],c,d,f)});else if(p instanceof Array&&h.name==x.k||!(p instanceof Array)&&p instanceof Object&&(h.name==x.k||h.name==x.g))d.length?B(a,[p[h.value]],c,d,f):f(p[h.value],h.value,p);else{w=u(a,[],h);for(i=0;i<w.length;i++)d.length?B(a,[p[w[i]]],
c,d,f):f(p[w[i]],w[i],p)}else f(p)}function D(a,b,c,d){var f,h,i;if(d===e)for(f=0;f<a.length||0==a.length&&!f;f++)D([a[f]],b,c,j);else if(c=c.slice(0),d=n({},d),f=c.shift()){f=f.children;f[0].children.length?(i=u(a,[],f[0].children[0]),1==i.length?h=i[0]:y("Key definition with multiple or no values")):h=f[0].value;i=u(a,[],f[1].children[0]);if(!i.length)return D(a,b,c,d);for(f=0;f<i.length;f++)d[h]=i[f],D(a,b,c,d)}else b.push(d)}
var E=RegExp('(!(?!=)|~)|(&&|\\|\\||===|==|!=|>=|<=|<|>)|(as(?= )|=|\\|=|\\+=|-=|\\*=|/=)|([-+*/]|and|or|xor)|([\\.,:|\\[\\]\\(\\){}])|(true|false)|(null)|(undefined)|(\\$[a-z_][a-z0-9_]*)|([a-z_][a-z0-9_]*)|(\\d+\\.\\d+)|(\\d+)|("(?:\\\\.|[^"])*")|(\\s+)',"gi"),F={T:1,B:2,aa:3,s:4,h:5,P:6,R:7,W:8,z:9,id:10,$:11,r:12,n:13,u:14},x={X:"argument",A:"assignment",v:"binary",BOOL:"bool",C:"collect",Y:"element",j:"filter",D:"function_call",F:"key",G:"key_all",m:"list",Z:"name",H:"null",k:"number",I:"object",
p:"operator",J:"parens",q:"pipe",K:"program",g:"string",w:"target",L:"unary",M:"undefined",N:"value",O:"variable"};function G(a){for(var b=0,c=[],d;d=E.exec(a);){b+d[0].length!=E.lastIndex&&(E.lastIndex=0,y("Unrecognized token '%0' at position %1",a.substr(d.index-1,1),d.index));for(b=0;14>=++b&&d[b]==e;);b==F.n&&(d[0]=d[0].slice(1,-1));c.push({type:b,index:E.lastIndex,data:d[0]});b=E.lastIndex}this.a=c;this.l=0}G.ma=F;l=G.prototype;
l.back=function(a){for(var b=this.l,c,a=0<a?a:1;a--;)for(;0<=--b&&(c=this.a[b]).type==F.u;);return c&&(c.type!=F.u?this.a[b]:k)||k};l.b=function(){return this.a[this.l]||j};l.next=function(a){this.l+=a||1;return this.a[this.l]||j};l.Q=function(){return this.l+1>=this.a.length};l.f=function(a){for(var b=this.l+1;a&&this.a[b]&&this.a[b].type==F.u;)b++;return this.a[b]||j};l.e=function(){for(var a;(a=this.f())&&a.type==F.u;)this.next();return this.next()||!this.Q()};
function H(a){this.id=0;this.a=new G(a);this.ka=this.add(x.K)}l=H.prototype;l.add=function(a){a instanceof Object?a.parent=this.b:a={id:this.id++,name:a,parent:this.b,index:0,children:[],i:j};this.b&&(a.index=this.b.children.push(a)-1,this.b.i=a);return this.b=a};l.d=function(a){a=this.add(a);this.c();return a};
l.parse=function(){for(var a=this.b.id,b;b=this.a.b();){switch(b.type){case F.T:this.V();break;case F.s:case F.B:this.U();break;case F.aa:this.ba(b);break;case F.P:this.d(x.BOOL).value=b.data;break;case F.R:this.d(x.H);break;case F.W:this.d(x.M);break;case F.z:this.ja();break;case F.id:this.da();break;case F.$:case F.r:case F.n:this.fa();break;case F.u:this.a.next();continue;default:switch(b.data){case ".":this.t();break;case "(":this.ha();break;case "[":this.ca();break;case "{":this.ga();break;case ",":this.ea();
break;case "|":this.ia();break;default:y("Unrecognized token '%0' at position %1",b.data,b.index)}}if(this.b.id&&this.b.id==a)return;this.a.next()}this.a.Q()&&this.b.name!=x.K&&y("Unexpected EOF");return this};
l.ba=function(a){var b=this.a.e(),c=1;this.b.i.name==x.q&&(this.b=this.b.i,c=2);this.o(x.A);switch(a.data){case "as":b&&b.type==F.z&&(this.d(x.Z).value=b.data);break;case "=":case "|=":case "+=":case "-=":case "*=":case "/=":this.b.i.name!=x.j&&y("Unexpected '%0' at position %1",a.data,a.index),"="!=a.data&&"|="!=a.data?(this.d(x.p).value="|=",this.add(x.v),this.d(x.j),this.d(x.p).value=a.data.substr(0,1),this.parse(),this.c()):(this.d(x.p).value=a.data,this.parse())}this.c(c)};
l.U=function(a){var b=this.a.b(),a=a||this.b.i,c;a&&(a.name==x.q||a.name==x.A&&3==a.children.length||b.type==F.s&&a.name==x.m||a.name==x.v&&(c=a.children[1])&&("&&"==b.data&&"||"==c.value||b.type==F.B&&"&&"!=b.data&&"||"!=b.data||c.type==F.B&&b.type==F.s||("*"==b.data||"/"==b.data)&&("+"==c.value||"-"==c.value)||"and"==b.data&&("xor"==c.value||"or"==c.value)||"xor"==b.data&&"or"==c.value))?(this.b=a,this.U(a.i),this.c()):"-"==b.data&&(!a||a.name==x.p||a.parent.name==x.m&&","==this.a.back().data||
a.parent.name==x.q)?this.V():a?(this.o(x.v),a=this.d(x.p),a.value=b.data,a.type=b.type,this.a.e(),this.parse(),this.c()):(b=this.a.b(),y("Unexpected '%0' at position %1",b.data,b.index))};l.ca=function(){var a;for(this.add(x.C);(a=this.a.f(g))&&"]"!=a.data;)this.a.e(),this.parse();a||y("Unexpected EOF");this.a.next();this.c();this.t(g)};
l.t=function(a){var b=g,c,d;if(a)if((c=this.a.f(g))&&("."==c.data||"["==c.data))this.o(x.j),this.o(x.w),this.c();else return;else this.add(x.j),this.d(x.w).value=".";for(;c=this.a.f();)if("["==c.data){b=g;for(this.a.next();(c=this.a.f(g))&&"]"!=c.data;)this.a.e(),this.parse(),b=k;b&&(this.d(x.G),b=k);if(!(d=this.a.e())||"]"!=d.data)y(d?"Unexpected '%0' at position %1":"Unexpected EOF",d&&d.data,d&&d.index)}else if((this.b.i.name==x.w&&"."!=c.data||"."==c.data&&this.a.next())&&(c=this.a.f())&&(c.type==
F.id||c.type==F.r))d=this.a.next(),d.type==F.id?this.d(x.g).value=d.data:this.d(x.k).value=parseFloat(d.data);else break;b||this.a.b()||y("Unexpected EOF");this.c()};
l.da=function(){var a,b;this.add(x.D).value=this.a.b().data;if((a=this.a.f(g))&&"("==a.data)if(this.a.e(),(a=this.a.f(g))&&")"!=a.data){for(this.add(x.X);(b=this.a.e())&&")"!=b.data;)this.parse();this.c();if(!(b=this.a.b())||")"!=b.data)y(b?"Unexpected '%0' at position %1":"Unexpected EOF",b&&b.data,b&&b.index)}else this.a.e();this.c();this.t(g)};
l.ea=function(){var a=this.b.children.length,b=this.b,c;for(a&&(b=this.b.children[a-1]).name==x.m?this.b=b:a?this.o(x.m):y("Unexpected '%0' at position %1",",",this.a.b().index);(c=this.a.f(g))&&(c.type!=F.h||","!=c.data&&")"!=c.data&&"]"!=c.data&&"}"!=c.data&&"|"!=c.data);)this.a.e(),this.parse();this.c()};l.fa=function(){var a=this.a.b();a.type==F.n?this.d(x.g).value=a.data:this.d(x.k).value=parseFloat(a.data)};
l.ga=function(){var a,b;for(this.add(x.I);(a=this.a.e())&&"}"!=a.data;)a:switch(a.type){case F.h:case F.z:case F.id:case F.r:case F.n:if(a.type==F.h&&","==a.data)if(this.b.children.length)if((b=this.a.f(g))&&b.type==F.h&&(","==b.data||"}"==b.data))y("Unexpected '%0' at position %1",b.data,b.index);else if(b)continue;else y("Unexpected EOF");else y("Unexpected '%0' at position %1",",",a.index);else if(a.type!=F.h||"."==a.data||"("==a.data){this.add(x.Y);switch(a.type){case F.r:case F.n:case F.id:this.d(x.F).value=
a.data;break;default:this.add(x.F),this.parse(),this.c()}if((b=this.a.f(g))&&":"==b.data)switch(this.a.e(),a=this.a.e(),a.type){case F.T:case F.s:case F.r:case F.n:case F.id:case F.h:case F.P:case F.R:case F.W:case F.z:this.add(x.N);a.type==F.s&&"-"!=a.data||a.type!=F.h||"."==a.data||"["==a.data||"("==a.data||"{"==a.data?this.parse():y("Unexpected '%0' at position %1",a.data,a.index);this.c(2);break a}else if(a.type!=F.h&&b&&(","==b.data||"}"==b.data)){this.add(x.N);this.add(x.j);this.d(x.w).value=
".";this.d(x.g).value=a.data;this.c(3);break}}default:y("Unexpected '%0' at position %1",(b?b:a).data,(b?b:a).index)}this.c()};l.ha=function(){var a;for(this.add(x.J);(a=this.a.e())&&")"!=a.data;)this.parse();this.c();this.t(g)};l.ia=function(){this.o(x.q);this.a.e();this.parse();this.c()};l.V=function(){var a=this.a.b();this.a.e()||y("Unexpected EOF");this.add(x.L).value=a.data;this.parse();this.c()};l.ja=function(){this.add(x.O).value=this.a.b().data;this.c();this.t(g)};
l.c=function(a){this.b.parent?(0<--a&&this.c(a),this.b=this.b.parent):y("jsq_up: Fatal internal error. Bug?")};l.o=function(a){var b;b=this.b.children.pop();b.parent.i=b.parent.children[b.parent.children.length-1]||j;this.add(a);this.add(b);this.c()};
z.S={"+":function(a,b){if(a instanceof Object||b instanceof Object){if(a instanceof Array||b instanceof Array){var c=a,d=b;c instanceof Array||(c=[c]);d instanceof Array||(d=[d]);return c.concat(d)}if(a instanceof Object&&b instanceof Object)return n({},a,b)}else return a+b},"-":function(a,b){var c;if(a instanceof Object||b instanceof Object){c=a;var d=b;if(c instanceof Array){d instanceof Array||(d=[d]);c=c.slice(0);for(var f=0;f<d.length;f++)for(var h=0;h<c.length;h++)c[h]===d[f]&&(c.splice(h,1),
f--)}else if(c instanceof Object&&d instanceof Object)for(f in c=n({},c),d)for(h in c)h==f&&delete c[h];else c=j}else c=a-b;return c},"*":function(a,b){return a*b},"/":function(a,b){return a/b},"&&":function(a,b){return a&&b},"||":function(a,b){return a||b},"==":function(a,b){return a==b},"===":function(a,b){return a===b},"!=":function(a,b){return a!=b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b},">":function(a,b){return a>b},"<":function(a,b){return a<b},and:function(a,b){return a&
b},or:function(a,b){return a|b},xor:function(a,b){return a^b}};var A={};function C(){for(var a=[],b=Array.prototype.slice.call(arguments,0),c=[],d,f,h,i;(d=b.shift())&&typeof d!=x.g;)a.push(d);if(typeof d!=x.g)return[];if(h=b.shift())i=b.shift()||this;b=new H(d);b.parse();return(f=b.ka.children[0])?(a.length?r(a,function(a){u([a],c,f)}):u(a,c,f),A={},"function"==typeof h&&r(c,function(){return h.apply(i,arguments)}),c):[]}C.Lexer=G;C.Parser=H;
C.fn={add:function(a,b){var c;r(a,function(a){c=c==e?a:z.S["+"](c,a)});return b.push(c)},"if":function(a,b,c){if(c&&c.name==x.m&&2<=c.children.length){var c=c.children,a=[a],d=u(a,[],c[0]),f;for(f=0;f<d.length;f++)if(d[f])return u(a,b,c[1]);c[2]&&u(a,b,c[2])}else y("if: Incorrect syntax on if() call")},empty:function(){},format:function(a,b,c){a instanceof Array&&(c&&c.name==x.g)&&(a=a.slice(0),a.unshift(c.value),b.push(v.apply(this,a)))},keys:function(a,b){r(a,function(a,d){b.push(d)})},length:function(a,
b){if(a instanceof Array||typeof a==x.g)b.push(a.length);else if(a instanceof Object){var c=0,d;for(d in a)c++;b.push(c)}else a===j&&b.push(0)},map:function(a,b,c){a instanceof Object&&r(a,function(a){b.push.apply(b,u([a],[],c))})},max:function(a,b,c){b.push(s("max",a,c))},min:function(a,b,c){b.push(s("min",a,c))},pairs:function(a,b){r(a,function(a,d){b.push([d,a])})},recurse:function(a,b,c,d){if(c&&c.name==x.j){d||(a=[a],d=0);d++;for(var f=0;f<a.length;f++){b.push(a[f]);var h=u([a[f]],[],c);h.length&&
this.la(h,b,c,d)}}},select:function(a,b,c){r(u([a],[],c),function(a){if(a)return k})||b.push(a)},tonumber:function(a,b,c){a=c?u([a],[],c):[a];for(c=0;c<a.length;c++)a[c]instanceof Object?b.push(j):"boolean"==typeof a[c]?b.push(~~a[c]):b.push(parseFloat(a[c])||j)},tostring:function(a,b,c,d){if(c){a=u([a],[],c);for(c=0;c<a.length;c++)a[c]!=d&&b.push(JSON.stringify(a[c]))}else a!=d&&b.push(JSON.stringify(a))}};var I="object"==typeof exports&&exports,J="object"==typeof global&&global;
J.global===J&&(m=J);"function"==typeof define&&"object"==typeof define.amd&&define.amd?(m.jsq=C,define(function(){return C})):I?"object"==typeof module&&module&&module.exports==I?(module.exports=C).jsq=C:I.jsq=C:m.jsq=C;})();
