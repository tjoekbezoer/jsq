;(function() {var e=void 0,g=!0,j=null,k=!1,l,m=this;function n(a){for(var b=1;b<arguments.length;b++)if(arguments[b]instanceof Object)for(var c in arguments[b])a[c]=arguments[b][c];return a}function q(a){if(!(a instanceof Object))return a;var b=new a.constructor;r(a,function(a,d){b[d]=q(a)});return b}function r(a,b){if(a instanceof Array)for(var c=0,d=a.length;c<d;c++){if(b(a[c],c,a)===k)return k}else if(a instanceof Object)for(c in a)if(b(a[c],c,a)===k)return k;return g}
function t(a,b,c){if(b instanceof Array&&!c)return Math[a].apply(Math,b);if(b instanceof Object){var d,f;r(b,function(b){var i=c?u([b],[],c)[0]:b;if(i!==e&&(d===e||Math[a](d,i)==i))d=i,c&&(f=b)});return c?f:d}return b}function v(a){var b=Array.prototype.slice.call(arguments,1);return"string"==typeof a&&a.replace(/%(\d+)/g,function(a,d){return b[d]||""})}function x(a){a||(a="Unknown error");throw v.apply(this,arguments);}
function y(a,b,c,d){var f=c.children[1].a,h=c.children[0],c=c.children[2],h=h.name==z.k?[h.a]:u(a,[],h),a=c.name==z.k?[c.a]:u(a,[],c),i,s;h.length||(h=[d]);a.length||(a=[d]);for(c=0;c<h.length;c++)for(i=0;i<a.length;i++){switch(f){case "+":case "-":case "*":case "/":case "and":case "or":case "xor":case "&&":case "||":case "==":case "===":case "!=":case ">=":case "<=":case ">":case "<":s=y.T[f](h[c],a[i])}s!=d&&b.push(s);s=d}}
function u(a,b,c){var d;switch(c.name){case z.B:var f=c.children;if(2==f.length)A[f[1].a]=u(a,[],f[0]),a instanceof Array?b.push.apply(b,a):b.push(a);else if(3==f.length){c=f[1].a;d=q(a);var h;"="==c?(h=u(a,[],f[2]).pop()||j,B(d,d,j,f[0].children,function(a,b,c){c[b]=h})):"|="==c&&B(d,d,j,f[0].children,function(a,b,c){h=u([c[b]],[],f[2]).pop()||j;c[b]=h});b.push.apply(b,d)}break;case z.w:y(a,b,c);break;case z.BOOL:b.push("true"==c.a?g:k);break;case z.D:d=[];c.children.length&&u(a,d,c.children[0]);
b.push(d);break;case z.m:for(d=0;d<c.children.length;d++)u(a,b,c.children[d]);break;case z.j:B(a,a,b,c.children);break;case z.F:if(c.a&&"function"==typeof C.fn[c.a])C.fn[c.a](a[0],b,c.children[0]&&c.children[0].children[0]);break;case z.I:b.push(j);break;case z.k:case z.n:b.push(c.a);break;case z.J:D(a,b,c.children);break;case z.K:c=u(a,[],c.children[0]);b.push.apply(b,c);break;case z.r:a=u(a,b,c.children[0]);a=a.splice(0,a.length);for(d=0;d<a.length;d++)u([a[d]],b,c.children[1]);break;case z.M:d=
c.a;c=u(a,[],c.children[0]);for(a=0;a<c.length;a++)"!"===d?b.push(!c[a]):"-"===d?b.push(-c[a]):"~"===d&&b.push(~c[a]);break;case z.N:b.push(e);break;case z.P:b.push.apply(b,A[c.a])}return b}
function B(a,b,c,d,f){var h,i,s,p,w;f||(f=function(a){a!=e&&c.push(a)});d=d.slice(0);a===b&&(h=d.shift(),!h.a&&h.children.length&&(b=u(b,[],h.children[0])));h=d.shift();for(s=0;s<b.length;s++)if(p=b[s],p!=e)if(h)if(h.name==z.H)r(p,!d.length?f:function(b){B(a,[b],c,d,f)});else if(p instanceof Array&&h.name==z.k||!(p instanceof Array)&&p instanceof Object&&(h.name==z.k||h.name==z.n))d.length?B(a,[p[h.a]],c,d,f):f(p[h.a],h.a,p);else{w=u(a,[],h);for(i=0;i<w.length;i++)d.length?B(a,[p[w[i]]],c,d,f):f(p[w[i]],
w[i],p)}else f(p)}function D(a,b,c,d){var f,h,i;if(d===e)for(f=0;f<a.length||0==a.length&&!f;f++)D([a[f]],b,c,j);else if(c=c.slice(0),d=n({},d),f=c.shift()){f=f.children;f[0].children.length?(i=u(a,[],f[0].children[0]),1==i.length?h=i[0]:x("Key definition with multiple or no values")):h=f[0].a;i=u(a,[],f[1].children[0]);if(!i.length)return D(a,b,c,d);for(f=0;f<i.length;f++)d[h]=i[f],D(a,b,c,d)}else b.push(d)}
var E=RegExp('(!(?!=)|~)|(&&|\\|\\||===|==|!=|>=|<=|<|>)|(as(?= )|=|\\|=|\\+=|-=|\\*=|/=)|([-+*/]|and|or|xor)|([\\.,:|\\[\\]\\(\\){}])|(true|false)|(null)|(undefined)|(\\$[a-z_][a-z0-9_]*)|([a-z_][a-z0-9_]*)|(\\d+\\.\\d+)|(\\d+)|("(?:\\\\.|[^"])*")|(\\s+)',"gi"),F={U:1,C:2,ba:3,t:4,h:5,Q:6,S:7,X:8,A:9,id:10,aa:11,s:12,o:13,v:14},z={Y:1,B:2,w:3,BOOL:4,D:5,Z:6,j:7,F:8,G:9,H:10,m:11,$:12,I:13,k:14,J:15,q:16,K:17,r:18,L:19,n:20,z:21,M:22,N:23,O:24,P:25};
function G(a){for(var b=0,c=[],d;d=E.exec(a);){b+d[0].length!=E.lastIndex&&(E.lastIndex=0,x("Unrecognized token '%0' at position %1",a.substr(d.index-1,1),d.index));for(b=0;14>=++b&&d[b]==e;);b==F.o&&(d[0]=d[0].slice(1,-1));c.push({type:b,index:E.lastIndex,a:d[0]});b=E.lastIndex}this.b=c;this.l=0}G.ma=F;l=G.prototype;l.back=function(a){for(var b=this.l,c,a=0<a?a:1;a--;)for(;0<=--b&&(c=this.b[b]).type==F.v;);return c&&(c.type!=F.v?this.b[b]:k)||k};l.c=function(){return this.b[this.l]||j};
l.next=function(a){this.l+=a||1;return this.b[this.l]||j};l.R=function(){return this.l+1>=this.b.length};l.g=function(a){for(var b=this.l+1;a&&this.b[b]&&this.b[b].type==F.v;)b++;return this.b[b]||j};l.f=function(){for(var a;(a=this.g())&&a.type==F.v;)this.next();return this.next()||!this.R()};function H(a){this.id=0;this.b=new G(a);this.la=this.add(z.L)}l=H.prototype;
l.add=function(a){a instanceof Object?a.parent=this.c:a={id:this.id++,name:a,parent:this.c,index:0,children:[],i:j};this.c&&(a.index=this.c.children.push(a)-1,this.c.i=a);return this.c=a};l.e=function(a){a=this.add(a);this.d();return a};
l.parse=function(){for(var a=this.c.id,b;b=this.b.c();){switch(b.type){case F.U:this.W();break;case F.t:case F.C:this.V();break;case F.ba:this.ca(b);break;case F.Q:this.e(z.BOOL).a=b.a;break;case F.S:this.e(z.I);break;case F.X:this.e(z.N);break;case F.A:this.ka();break;case F.id:this.ea();break;case F.aa:case F.s:case F.o:this.ga();break;case F.v:this.b.next();continue;default:switch(b.a){case ".":this.u();break;case "(":this.ia();break;case "[":this.da();break;case "{":this.ha();break;case ",":this.fa();
break;case "|":this.ja();break;default:x("Unrecognized token '%0' at position %1",b.a,b.index)}}if(this.c.id&&this.c.id==a)return;this.b.next()}this.b.R()&&this.c.name!=z.L&&x("Unexpected EOF");return this};
l.ca=function(a){var b=this.b.f(),c=1;this.c.i.name==z.r&&(this.c=this.c.i,c=2);this.p(z.B);switch(a.a){case "as":b&&b.type==F.A&&(this.e(z.$).a=b.a);break;case "=":case "|=":case "+=":case "-=":case "*=":case "/=":this.c.i.name!=z.j&&x("Unexpected '%0' at position %1",a.a,a.index),"="!=a.a&&"|="!=a.a?(this.e(z.q).a="|=",this.add(z.w),this.e(z.j),this.e(z.q).a=a.a.substr(0,1),this.parse(),this.d()):(this.e(z.q).a=a.a,this.parse())}this.d(c)};
l.V=function(a){var b=this.b.c(),a=a||this.c.i,c;a&&(a.name==z.r||a.name==z.B&&3==a.children.length||b.type==F.t&&a.name==z.m||a.name==z.w&&(c=a.children[1])&&("&&"==b.a&&"||"==c.a||b.type==F.C&&"&&"!=b.a&&"||"!=b.a||c.type==F.C&&b.type==F.t||("*"==b.a||"/"==b.a)&&("+"==c.a||"-"==c.a)||"and"==b.a&&("xor"==c.a||"or"==c.a)||"xor"==b.a&&"or"==c.a))?(this.c=a,this.V(a.i),this.d()):"-"==b.a&&(!a||a.name==z.q||a.parent.name==z.m&&","==this.b.back().a||a.parent.name==z.r)?this.W():a?(this.p(z.w),a=this.e(z.q),
a.a=b.a,a.type=b.type,this.b.f(),this.parse(),this.d()):(b=this.b.c(),x("Unexpected '%0' at position %1",b.a,b.index))};l.da=function(){var a;for(this.add(z.D);(a=this.b.g(g))&&"]"!=a.a;)this.b.f(),this.parse();a||x("Unexpected EOF");this.b.next();this.d();this.u(g)};
l.u=function(a){var b=g,c,d;if(a)if((c=this.b.g(g))&&("."==c.a||"["==c.a))this.p(z.j),this.p(z.z),this.d();else return;else this.add(z.j),this.e(z.z).a=".";for(;c=this.b.g();)if("["==c.a){b=g;for(this.b.next();(c=this.b.g(g))&&"]"!=c.a;)this.b.f(),this.parse(),b=k;b&&(this.e(z.H),b=k);if(!(d=this.b.f())||"]"!=d.a)x(d?"Unexpected '%0' at position %1":"Unexpected EOF",d&&d.a,d&&d.index)}else if((this.c.i.name==z.z&&"."!=c.a||"."==c.a&&this.b.next())&&(c=this.b.g())&&(c.type==F.id||c.type==F.s))d=this.b.next(),
d.type==F.id?this.e(z.n).a=d.a:this.e(z.k).a=parseFloat(d.a);else break;b||this.b.c()||x("Unexpected EOF");this.d()};l.ea=function(){var a,b;this.add(z.F).a=this.b.c().a;if((a=this.b.g(g))&&"("==a.a)if(this.b.f(),(a=this.b.g(g))&&")"!=a.a){for(this.add(z.Y);(b=this.b.f())&&")"!=b.a;)this.parse();this.d();if(!(b=this.b.c())||")"!=b.a)x(b?"Unexpected '%0' at position %1":"Unexpected EOF",b&&b.a,b&&b.index)}else this.b.f();this.d();this.u(g)};
l.fa=function(){var a=this.c.children.length,b=this.c,c;for(a&&(b=this.c.children[a-1]).name==z.m?this.c=b:a?this.p(z.m):x("Unexpected '%0' at position %1",",",this.b.c().index);(c=this.b.g(g))&&(c.type!=F.h||","!=c.a&&")"!=c.a&&"]"!=c.a&&"}"!=c.a&&"|"!=c.a);)this.b.f(),this.parse();this.d()};l.ga=function(){var a=this.b.c();a.type==F.o?this.e(z.n).a=a.a:this.e(z.k).a=parseFloat(a.a)};
l.ha=function(){var a,b;for(this.add(z.J);(a=this.b.f())&&"}"!=a.a;)a:switch(a.type){case F.h:case F.A:case F.id:case F.s:case F.o:if(a.type==F.h&&","==a.a)if(this.c.children.length)if((b=this.b.g(g))&&b.type==F.h&&(","==b.a||"}"==b.a))x("Unexpected '%0' at position %1",b.a,b.index);else if(b)continue;else x("Unexpected EOF");else x("Unexpected '%0' at position %1",",",a.index);else if(a.type!=F.h||"."==a.a||"("==a.a){this.add(z.Z);switch(a.type){case F.s:case F.o:case F.id:this.e(z.G).a=a.a;break;
default:this.add(z.G),this.parse(),this.d()}if((b=this.b.g(g))&&":"==b.a)switch(this.b.f(),a=this.b.f(),a.type){case F.U:case F.t:case F.s:case F.o:case F.id:case F.h:case F.Q:case F.S:case F.X:case F.A:this.add(z.O);a.type==F.t&&"-"!=a.a||a.type!=F.h||"."==a.a||"["==a.a||"("==a.a||"{"==a.a?this.parse():x("Unexpected '%0' at position %1",a.a,a.index);this.d(2);break a}else if(a.type!=F.h&&b&&(","==b.a||"}"==b.a)){this.add(z.O);this.add(z.j);this.e(z.z).a=".";this.e(z.n).a=a.a;this.d(3);break}}default:x("Unexpected '%0' at position %1",
(b?b:a).a,(b?b:a).index)}this.d()};l.ia=function(){var a;for(this.add(z.K);(a=this.b.f())&&")"!=a.a;)this.parse();this.d();this.u(g)};l.ja=function(){this.p(z.r);this.b.f();this.parse();this.d()};l.W=function(){var a=this.b.c();this.b.f()||x("Unexpected EOF");this.add(z.M).a=a.a;this.parse();this.d()};l.ka=function(){this.add(z.P).a=this.b.c().a;this.d();this.u(g)};l.d=function(a){this.c.parent?(0<--a&&this.d(a),this.c=this.c.parent):x("jsq_up: Fatal internal error. Bug?")};
l.p=function(a){var b;b=this.c.children.pop();b.parent.i=b.parent.children[b.parent.children.length-1]||j;this.add(a);this.add(b);this.d()};
y.T={"+":function(a,b){if(a instanceof Object||b instanceof Object){if(a instanceof Array||b instanceof Array){var c=a,d=b;c instanceof Array||(c=[c]);d instanceof Array||(d=[d]);return c.concat(d)}if(a instanceof Object&&b instanceof Object)return n({},a,b)}else return a+b},"-":function(a,b){var c;if(a instanceof Object||b instanceof Object){c=a;var d=b;if(c instanceof Array){d instanceof Array||(d=[d]);c=c.slice(0);for(var f=0;f<d.length;f++)for(var h=0;h<c.length;h++)c[h]===d[f]&&(c.splice(h,1),
f--)}else if(c instanceof Object&&d instanceof Object)for(f in c=n({},c),d)for(h in c)h==f&&delete c[h];else c=j}else c=a-b;return c},"*":function(a,b){return a*b},"/":function(a,b){return a/b},"&&":function(a,b){return a&&b},"||":function(a,b){return a||b},"==":function(a,b){return a==b},"===":function(a,b){return a===b},"!=":function(a,b){return a!=b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b},">":function(a,b){return a>b},"<":function(a,b){return a<b},and:function(a,b){return a&
b},or:function(a,b){return a|b},xor:function(a,b){return a^b}};var A={};function C(){for(var a=[],b=Array.prototype.slice.call(arguments,0),c=[],d,f,h,i;(d=b.shift())&&"string"!=typeof d;)a.push(d);if("string"!=typeof d)return[];if(h=b.shift())i=b.shift()||this;b=new H(d);b.parse();return(f=b.la.children[0])?(a.length?r(a,function(a){u([a],c,f)}):u(a,c,f),A={},"function"==typeof h&&r(c,function(){return h.apply(i,arguments)}),c):[]}
C.fn={add:function(a,b){var c;r(a,function(a){c=c==e?a:y.T["+"](c,a)});return b.push(c)},"if":function(a,b,c){if(c&&c.name==z.m&&2<=c.children.length){var c=c.children,a=[a],d=u(a,[],c[0]),f;for(f=0;f<d.length;f++)if(d[f])return u(a,b,c[1]);c[2]&&u(a,b,c[2])}else x("if: Incorrect syntax on if() call")},empty:function(){},format:function(a,b,c){a instanceof Array&&(c&&c.name==z.n)&&(a=a.slice(0),a.unshift(c.a),b.push(v.apply(this,a)))},keys:function(a,b){r(a,function(a,d){b.push(d)})},length:function(a,
b){if(a instanceof Array||"string"==typeof a)b.push(a.length);else if(a instanceof Object){var c=0,d;for(d in a)c++;b.push(c)}else a===j&&b.push(0)},map:function(a,b,c){a instanceof Object&&r(a,function(a){b.push.apply(b,u([a],[],c))})},max:function(a,b,c){b.push(t("max",a,c))},min:function(a,b,c){b.push(t("min",a,c))},pairs:function(a,b){r(a,function(a,d){b.push([d,a])})},recurse:function(a,b,c,d){if(c&&c.name==z.j){d||(a=[a],d=0);d++;for(var f=0;f<a.length;f++){b.push(a[f]);var h=u([a[f]],[],c);
h.length&&this.recurse(h,b,c,d)}}},select:function(a,b,c){r(u([a],[],c),function(a){if(a)return k})||b.push(a)},tonumber:function(a,b,c){a=c?u([a],[],c):[a];for(c=0;c<a.length;c++)a[c]instanceof Object?b.push(j):"boolean"==typeof a[c]?b.push(~~a[c]):b.push(parseFloat(a[c])||j)},tostring:function(a,b,c,d){if(c){a=u([a],[],c);for(c=0;c<a.length;c++)a[c]!=d&&b.push(JSON.stringify(a[c]))}else a!=d&&b.push(JSON.stringify(a))}};var I="object"==typeof exports&&exports,J="object"==typeof global&&global;
J.global===J&&(m=J);"function"==typeof define&&"object"==typeof define.amd&&define.amd?(m.jsq=C,define(function(){return C})):I?"object"==typeof module&&module&&module.exports==I?(module.exports=C).jsq=C:I.jsq=C:m.jsq=C;})();
