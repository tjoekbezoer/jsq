;(function() {var h=void 0,i=!0,j=null,l=!1,m,p=this;function q(a){if(!(a instanceof Object))return a;var b=new a.constructor;r(a,function(a,d){b[d]=q(a)});return b}function r(a,b){if(a instanceof Array)for(var c=0,d=a.length;c<d;c++){if(b(a[c],c,a)===l)return l}else if(a instanceof Object)for(c in a)if(b(a[c],c,a)===l)return l;return i}function s(a){for(var b=1;b<arguments.length;b++)if(arguments[b]instanceof Object)for(var c in arguments[b])a[c]=arguments[b][c];return a}
function t(a){var b=[],c;for(c in a)b.push(c);return b.sort()}function u(a,b){var c=u.q(a),d=u.q(b);if(c!=d)return u.types[c]-u.types[d];if(a instanceof Array){if(a.length!=b.length)return a.length-b.length;for(d=0;d<a.length;d++)if(c=u(a[d],b[d]),0!=c)return c;return 0}if(a instanceof Object){var d=t(a),e=t(b),c=u(d,e);return 0==c?u(v(a,d),v(b,e)):c}return"string"==c?a>b?1:a===b?0:-1:a-b}
function w(a){return"number"==typeof a&&"number"||"string"==typeof a&&"string"||"boolean"==typeof a&&"boolean"||l}function x(a){var b=Array.prototype.slice.call(arguments,1);return"string"==typeof a&&a.replace(/%(\d+)/g,function(a,d){return b[d]||""})}function v(a,b){var c=[];b||(b=t(a));for(var d=0;d<b.length;d++)c.push(a[b[d]]);return c}
function y(a,b,c){if(b instanceof Array&&!c)return Math[a].apply(Math,b);if(b instanceof Object){var d,e;r(b,function(b){var g=c?z([b],[],c)[0]:b;if(g!==h&&(d===h||Math[a](d,g)==g))d=g,c&&(e=b)});return c?e:d}return b}function B(a){a||(a="Unknown error");throw x.apply(this,arguments);}
function C(a,b,c,d){var e=c.children[1].a,f=c.children[0],c=c.children[2],f=f.name==D?[f.a]:z(a,[],f),a=c.name==D?[c.a]:z(a,[],c),g,k;f.length||(f=[d]);a.length||(a=[d]);for(c=0;c<f.length;c++)for(g=0;g<a.length;g++){switch(e){case "==":case "!=":k=!w(f[c])&&!w(a[g])?C.m[e](u(f[c],a[g])):C.l[e](f[c],a[g]);break;case ">=":case "<=":case ">":case "<":k=w(f[c]);var n=w(a[g]);if(!k||!n||"boolean"==k||"boolean"==n){k=C.m[e](u(f[c],a[g]));break}case "===":case "+":case "-":case "*":case "/":case "and":case "or":case "xor":case "&&":case "||":k=
C.l[e](f[c],a[g])}k!=d&&b.push(k);k=d}}
function z(a,b,c){var d,e;switch(c.name){case E:var f=c.children;if(2==f.length)F[f[1].a]=z(a,[],f[0]),a instanceof Array?b.push.apply(b,a):b.push(a);else if(3==f.length){c=f[1].a;d=q(a);var g,k;"="==c?(g=z(a,[],f[2]).pop(),k=g!=h?g:j,G(d,d,j,f[0].children,function(a,b,c){c[b]=k})):"|="==c&&G(d,d,j,f[0].children,function(a,b,c){g=z([c[b]],[],f[2]).pop();k=g!=h?g:j;c[b]=k});b.push.apply(b,d)}break;case H:C(a,b,c);break;case I:b.push("true"==c.a?i:l);break;case J:d=[];c.children.length&&z(a,d,c.children[0]);
b.push(d);break;case K:for(d=0;d<c.children.length;d++)z(a,b,c.children[d]);break;case L:G(a,a,b,c.children);break;case M:if(c.a&&"function"==typeof N.fn[c.a])N.fn[c.a](a[0],b,c.children[0]&&c.children[0].children[0]);break;case O:b.push(j);break;case D:case P:b.push(c.a);break;case Q:R(a,b,c.children);break;case S:c=z(a,[],c.children[0]);b.push.apply(b,c);break;case T:a=z(a,b,c.children[0]);e=a.length;a=a.splice(0,e);for(d=0;d<e||0==d+e;d++)z(0<e?[a[d]]:[],b,c.children[1]);break;case U:d=c.a;c=z(a,
[],c.children[0]);for(a=0;a<c.length;a++)"!"===d?b.push(!c[a]):"-"===d?b.push(-c[a]):"~"===d&&b.push(~c[a]);break;case V:b.push(h);break;case W:b.push.apply(b,F[c.a])}return b}
function G(a,b,c,d,e){var f,g,k,n,A;e||(e=function(a){a!=h&&c.push(a)});d=d.slice(0);a===b&&(f=d.shift(),!f.a&&f.children.length&&(b=z(b,[],f.children[0])));f=d.shift();for(k=0;k<b.length;k++)if(n=b[k],n!=h)if(f)if(f.name==X)r(n,!d.length?e:function(b){G(a,[b],c,d,e)});else if(n instanceof Array&&f.name==D||!(n instanceof Array)&&n instanceof Object&&(f.name==D||f.name==P))d.length?G(a,[n[f.a]],c,d,e):e(n[f.a],f.a,n);else{A=z(a,[],f);for(g=0;g<A.length;g++)d.length?G(a,[n[A[g]]],c,d,e):e(n[A[g]],
A[g],n)}else e(n)}function R(a,b,c,d){var e,f,g;if(d===h)for(e=0;e<a.length||0==a.length&&!e;e++)R([a[e]],b,c,j);else if(c=c.slice(0),d=s({},d),e=c.shift()){e=e.children;e[0].children.length?(g=z(a,[],e[0].children[0]),1==g.length?f=g[0]:B("Key definition with multiple or no values")):f=e[0].a;g=z(a,[],e[1].children[0]);if(!g.length)return R(a,b,c,d);for(e=0;e<g.length;e++)d[f]=g[e],R(a,b,c,d)}else b.push(d)}u.q=function(a){return a instanceof Array&&"array"||a===j&&"null"||typeof a};
u.types={"null":1,"boolean":2,number:3,string:4,array:5,object:6};var Y=RegExp('(!(?!=)|~)|(&&|\\|\\||===|==|!=|>=|<=|<|>)|(as(?= )|=|\\|=|\\+=|-=|\\*=|/=)|([-+*/]|and|or|xor)|([\\.,:|\\[\\]\\(\\){}])|(true|false)|(null)|(undefined)|(\\$[a-z_][a-z0-9_]*)|([a-z_][a-z0-9_]*)|(\\d+\\.\\d+)|(\\d+)|("(?:\\\\.|[^"])*")|(\\s+)',"gi"),E=2,H=3,I=4,J=5,L=7,M=8,X=10,K=11,O=13,D=14,Q=15,S=17,T=18,P=20,U=22,V=23,W=25;
function aa(a){for(var b=0,c=[],d;d=Y.exec(a);){b+d[0].length!=Y.lastIndex&&(Y.lastIndex=0,B("Unrecognized token '%0' at position %1",a.substr(d.index-1,1),d.index));for(b=0;14>=++b&&d[b]==h;);13==b&&(d[0]=d[0].slice(1,-1));c.push({type:b,index:Y.lastIndex,a:d[0]});b=Y.lastIndex}this.b=c;this.i=0}m=aa.prototype;m.back=function(a){for(var b=this.i,c,a=0<a?a:1;a--;)for(;0<=--b&&14==(c=this.b[b]).type;);return c&&(14!=c.type?this.b[b]:l)||l};m.c=function(){return this.b[this.i]||j};
m.next=function(a){this.i+=a||1;return this.b[this.i]||j};m.n=function(){return this.i+1>=this.b.length};m.g=function(a){for(var b=this.i+1;a&&this.b[b]&&14==this.b[b].type;)b++;return this.b[b]||j};m.f=function(){for(var a;(a=this.g())&&14==a.type;)this.next();return this.next()||!this.n()};function ba(a){this.id=0;this.b=new aa(a);this.C=this.add(19)}m=ba.prototype;
m.add=function(a){a instanceof Object?a.parent=this.c:a={id:this.id++,name:a,parent:this.c,index:0,children:[],h:j};this.c&&(a.index=this.c.children.push(a)-1,this.c.h=a);return this.c=a};m.e=function(a){a=this.add(a);this.d();return a};
m.parse=function(){for(var a=this.c.id,b;b=this.b.c();){switch(b.type){case 1:this.p();break;case 4:case 2:this.o();break;case 3:this.r(b);break;case 6:this.e(I).a=b.a;break;case 7:this.e(O);break;case 8:this.e(V);break;case 9:this.B();break;case 10:this.t();break;case 11:case 12:case 13:this.v();break;case 14:this.b.next();continue;default:switch(b.a){case ".":this.k();break;case "(":this.z();break;case "[":this.s();break;case "{":this.w();break;case ",":this.u();break;case "|":this.A();break;default:B("Unrecognized token '%0' at position %1",
b.a,b.index)}}if(this.c.id&&this.c.id==a)return;this.b.next()}this.b.n()&&19!=this.c.name&&B("Unexpected EOF");return this};
m.r=function(a){var b=this.b.f(),c=1;this.c.h.name==T&&(this.c=this.c.h,c=2);this.j(E);switch(a.a){case "as":b&&9==b.type&&(this.e(12).a=b.a);break;case "=":case "|=":case "+=":case "-=":case "*=":case "/=":this.c.h.name!=L&&B("Unexpected '%0' at position %1",a.a,a.index),"="!=a.a&&"|="!=a.a?(this.e(16).a="|=",this.add(H),this.add(L),this.e(21).a=".",this.d(),this.e(16).a=a.a.substr(0,1),this.parse(),this.d()):(this.e(16).a=a.a,this.parse())}this.d(c)};
m.o=function(a){var b=this.b.c(),a=a||this.c.h,c;a&&(a.name==T||a.name==E&&3==a.children.length||4==b.type&&a.name==K||a.name==H&&(c=a.children[1])&&("&&"==b.a&&"||"==c.a||2==b.type&&"&&"!=b.a&&"||"!=b.a||2==c.type&&4==b.type||("*"==b.a||"/"==b.a)&&("+"==c.a||"-"==c.a)||"and"==b.a&&("xor"==c.a||"or"==c.a)||"xor"==b.a&&"or"==c.a))?(this.c=a,this.o(a.h),this.d()):"-"==b.a&&(!a||16==a.name||a.parent.name==K&&","==this.b.back().a||a.parent.name==T)?this.p():a?(this.j(H),a=this.e(16),a.a=b.a,a.type=b.type,
this.b.f(),this.parse(),this.d()):(b=this.b.c(),B("Unexpected '%0' at position %1",b.a,b.index))};m.s=function(){var a;for(this.add(J);(a=this.b.g(i))&&"]"!=a.a;)this.b.f(),this.parse();a||B("Unexpected EOF");this.b.next();this.d();this.k(i)};
m.k=function(a){var b=i,c,d;if(a)if((c=this.b.g(i))&&("."==c.a||"["==c.a))this.j(L),this.j(21),this.d();else return;else this.add(L),this.e(21).a=".";for(;c=this.b.g();)if("["==c.a){b=i;for(this.b.next();(c=this.b.g(i))&&"]"!=c.a;)this.b.f(),this.parse(),b=l;b&&(this.e(X),b=l);if(!(d=this.b.f())||"]"!=d.a)B(d?"Unexpected '%0' at position %1":"Unexpected EOF",d&&d.a,d&&d.index)}else if((21==this.c.h.name&&"."!=c.a||"."==c.a&&this.b.next())&&(c=this.b.g())&&(10==c.type||12==c.type))d=this.b.next(),
10==d.type?this.e(P).a=d.a:this.e(D).a=parseFloat(d.a);else break;b||this.b.c()||B("Unexpected EOF");this.d()};m.t=function(){var a,b;this.add(M).a=this.b.c().a;if((a=this.b.g(i))&&"("==a.a)if(this.b.f(),(a=this.b.g(i))&&")"!=a.a){for(this.add(1);(b=this.b.f())&&")"!=b.a;)this.parse();this.d();if(!(b=this.b.c())||")"!=b.a)B(b?"Unexpected '%0' at position %1":"Unexpected EOF",b&&b.a,b&&b.index)}else this.b.f();this.d();this.k(i)};
m.u=function(){var a=this.c.children.length,b=this.c,c;for(a&&(b=this.c.children[a-1]).name==K?this.c=b:a?this.j(K):B("Unexpected '%0' at position %1",",",this.b.c().index);(c=this.b.g(i))&&(5!=c.type||","!=c.a&&")"!=c.a&&"]"!=c.a&&"}"!=c.a&&"|"!=c.a);)this.b.f(),this.parse();this.d()};m.v=function(){var a=this.b.c();13==a.type?this.e(P).a=a.a:this.e(D).a=parseFloat(a.a)};
m.w=function(){var a,b;for(this.add(Q);(a=this.b.f())&&"}"!=a.a;)a:switch(a.type){case 5:case 9:case 10:case 12:case 13:if(5==a.type&&","==a.a)if(this.c.children.length)if((b=this.b.g(i))&&5==b.type&&(","==b.a||"}"==b.a))B("Unexpected '%0' at position %1",b.a,b.index);else if(b)continue;else B("Unexpected EOF");else B("Unexpected '%0' at position %1",",",a.index);else if(5!=a.type||"."==a.a||"("==a.a){this.add(6);switch(a.type){case 12:case 13:case 10:this.e(9).a=a.a;break;default:this.add(9),this.parse(),
this.d()}if((b=this.b.g(i))&&":"==b.a)switch(this.b.f(),a=this.b.f(),a.type){case 1:case 4:case 12:case 13:case 10:case 5:case 6:case 7:case 8:case 9:this.add(24);4==a.type&&"-"!=a.a||5!=a.type||"."==a.a||"["==a.a||"("==a.a||"{"==a.a?this.parse():B("Unexpected '%0' at position %1",a.a,a.index);this.d(2);break a}else if(5!=a.type&&b&&(","==b.a||"}"==b.a)){this.add(24);this.add(L);this.e(21).a=".";this.e(P).a=a.a;this.d(3);break}}default:B("Unexpected '%0' at position %1",(b?b:a).a,(b?b:a).index)}this.d()};
m.z=function(){var a;for(this.add(S);(a=this.b.f())&&")"!=a.a;)this.parse();this.d();this.k(i)};m.A=function(){this.j(T);this.b.f();this.parse();this.d()};m.p=function(){var a=this.b.c();this.b.f()||B("Unexpected EOF");this.add(U).a=a.a;this.parse();this.d()};m.B=function(){this.add(W).a=this.b.c().a;this.d();this.k(i)};m.d=function(a){this.c.parent?(0<--a&&this.d(a),this.c=this.c.parent):B("jsq_up: Fatal internal error. Bug?")};
m.j=function(a){var b;b=this.c.children.pop();b.parent.h=b.parent.children[b.parent.children.length-1]||j;this.add(a);this.add(b);this.d()};C.m={"==":function(a){return 0==a},"!=":function(a){return 0!=a},">=":function(a){return 0<=a},"<=":function(a){return 0>=a},">":function(a){return 0<a},"<":function(a){return 0>a}};
C.l={"+":function(a,b){if(a instanceof Object||b instanceof Object){if(a instanceof Array||b instanceof Array){var c=a,d=b;c instanceof Array||(c=[c]);d instanceof Array||(d=[d]);return c.concat(d)}if(a instanceof Object&&b instanceof Object)return s({},a,b)}else return a+b},"-":function(a,b){var c;if(a instanceof Object||b instanceof Object){c=a;var d=b;if(c instanceof Array){d instanceof Array||(d=[d]);c=c.slice(0);for(var e=0;e<d.length;e++)for(var f=0;f<c.length;f++)c[f]===d[e]&&(c.splice(f,1),
e--)}else if(c instanceof Object&&d instanceof Object)for(e in c=s({},c),d)for(f in c)f==e&&delete c[f];else c=j}else c=a-b;return c},"*":function(a,b){return a*b},"/":function(a,b){return a/b},"&&":function(a,b){return a&&b},"||":function(a,b){return a||b},"==":function(a,b){return a==b},"===":function(a,b){return a===b},"!=":function(a,b){return a!=b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b},">":function(a,b){return a>b},"<":function(a,b){return a<b},and:function(a,b){return a&
b},or:function(a,b){return a|b},xor:function(a,b){return a^b}};var F={};function N(){for(var a=[],b=Array.prototype.slice.call(arguments,0),c=[],d,e,f,g;(d=b.shift())&&"string"!=typeof d;)a.push(d);if("string"!=typeof d)return[];if(f=b.shift())g=b.shift()||this;b=new ba(d);b.parse();return(e=b.C.children[0])?(a.length?r(a,function(a){z([a],c,e)}):z(a,c,e),F={},"function"==typeof f&&r(c,function(){return f.apply(g,arguments)}),c):[]}
N.fn={add:function(a,b){var c;r(a,function(a){c=c==h?a:C.l["+"](c,a)});return b.push(c)},"if":function(a,b,c){if(c&&c.name==K&&2<=c.children.length){var c=c.children,a=[a],d=z(a,[],c[0]),e;for(e=0;e<d.length;e++)if(d[e])return z(a,b,c[1]);c[2]&&z(a,b,c[2])}else B("if: Incorrect syntax on if() call")},empty:function(){},format:function(a,b,c){a instanceof Array&&(c&&c.name==P)&&(a=a.slice(0),a.unshift(c.a),b.push(x.apply(this,a)))},keys:function(a,b){r(a,function(a,d){b.push(d)})},length:function(a,
b){if(a instanceof Array||"string"==typeof a)b.push(a.length);else if(a instanceof Object){var c=0,d;for(d in a)c++;b.push(c)}else a===j&&b.push(0)},map:function(a,b,c){a instanceof Object&&r(a,function(a){b.push.apply(b,z([a],[],c))})},max:function(a,b,c){b.push(y("max",a,c))},min:function(a,b,c){b.push(y("min",a,c))},pairs:function(a,b){r(a,function(a,d){b.push([d,a])})},recurse:function(a,b,c,d){if(c&&c.name==L){d||(a=[a],d=0);d++;for(var e=0;e<a.length;e++){b.push(a[e]);var f=z([a[e]],[],c);f.length&&
this.recurse(f,b,c,d)}}},select:function(a,b,c){r(z([a],[],c),function(a){if(a)return l})||b.push(a)},sort:function(a,b){a instanceof Array||B("sort: Can only sort arrays");b.push(a.sort(u))},tonumber:function(a,b,c){a=c?z([a],[],c):[a];for(c=0;c<a.length;c++)a[c]instanceof Object?b.push(j):"boolean"==typeof a[c]?b.push(~~a[c]):b.push(parseFloat(a[c])||j)},tostring:function(a,b,c,d){if(c){a=z([a],[],c);for(c=0;c<a.length;c++)a[c]!=d&&b.push(JSON.stringify(a[c]))}else a!=d&&b.push(JSON.stringify(a))},
unique:function(a,b){for(var c=-1,d=a.length,e=[];++c<d;){var f=a[c],g;a:{for(g=e.length-1;0<=g;g--)if(e[g]===f)break a;g=-1}0>g&&e.push(f)}b.push(e)}};var Z="object"==typeof exports&&exports,$="object"==typeof global&&global;$.global===$&&(p=$);"function"==typeof define&&"object"==typeof define.amd&&define.amd?(p.jsq=N,define(function(){return N})):Z?"object"==typeof module&&module&&module.exports==Z?(module.exports=N).jsq=N:Z.jsq=N:p.jsq=N;})();
